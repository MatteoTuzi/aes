/******************************************************************************
 * audio_filtering.h
 * Lab 3 – Step 2: FIR Audio Filtering
 * University of Cagliari – Advanced Embedded Systems (AES)
 ******************************************************************************
 * Defines, globals, and function declarations for real-time FIR audio
 * filtering on Zybo Z7 (SSM2603, AXI-I2S, AXI FIFO).
 ******************************************************************************/

#ifndef AUDIO_FILTERING_H
#define AUDIO_FILTERING_H

#include "xparameters.h"
#include "xiicps.h"

/* ---------------------------------------------------------------------------
 * I2S register offsets
 * --------------------------------------------------------------------------- */
#define I2S_RESET_REG         0x00
#define I2S_CTRL_REG          0x04
#define I2S_CLK_CTRL_REG      0x08
#define I2S_FIFO_STS_REG      0x20
#define I2S_RX_FIFO_REG       0x28
#define I2S_TX_FIFO_REG       0x2C

/* ---------------------------------------------------------------------------
 * AXI FIFO register offsets
 * --------------------------------------------------------------------------- */
#define FIFO_ISR              0x00
#define FIFO_IER              0x04
#define FIFO_TDFV             0x0C
#define FIFO_TDFD             0x10
#define FIFO_TLR              0x14
#define FIFO_RDFO             0x1C
#define FIFO_RDFD             0x20
#define FIFO_RLR              0x24
#define FIFO_TDR              0x2C
#define FIFO_RDR              0x30

/* ---------------------------------------------------------------------------
 * FIR buffer length
 * --------------------------------------------------------------------------- */
#define FIR_BUF_LEN           29   /* max(N_LP_AGG, N_HP_AGG, N_HP, N_LP) */

/* ---------------------------------------------------------------------------
 * I²C / SSM2603
 * --------------------------------------------------------------------------- */
#define IIC_SLAVE_ADDR        0b0011010
#define IIC_SCLK_RATE         100000

/* ---------------------------------------------------------------------------
 * Hardware base addresses (from xparameters)
 * --------------------------------------------------------------------------- */
#define AUDIO_IIC_ID          XPAR_XIICPS_0_DEVICE_ID
#define AUDIO_CTRL_BASEADDR   XPAR_AXI_I2S_ADI_0_S00_AXI_BASEADDR
#define SCU_TIMER_ID          XPAR_SCUTIMER_DEVICE_ID
#define SWI_BASE_ADDR         XPAR_AXI_GPIO_2_BASEADDR
#define LED_BASE_ADDR         XPAR_AXI_GPIO_1_BASEADDR
#define BUT_BASE_ADDR         XPAR_AXI_GPIO_0_BASEADDR
#define AUDIO_FIFO            XPAR_AXI_FIFO_MM_S_0_BASEADDR
#define FIR_FIFO              XPAR_AXI_FIFO_MM_S_1_BASEADDR

/* ---------------------------------------------------------------------------
 * FIR filter coefficients (macros for array initialisers)
 * --------------------------------------------------------------------------- */
#define coeffLP  \
	-1.692219e-02, 5.043750e-02, 3.935835e-02, 4.341238e-02, 5.137933e-02, \
	5.982048e-02, 6.748827e-02, 7.379049e-02, 7.824605e-02, 8.052560e-02, \
	8.052560e-02, 7.824605e-02, 7.379049e-02, 6.748827e-02, 5.982048e-02, \
	5.137933e-02, 4.341238e-02, 3.935835e-02, 5.043750e-02, -0.0169221860
#define coeffHP  \
	-3.942071e-02, -5.929114e-03, 1.430997e-02, 4.069053e-02, 5.762197e-02, \
	4.843584e-02, 4.349633e-03, -6.932913e-02, -1.527862e-01, -2.187328e-01, \
	7.562085e-01, -2.187328e-01, -1.527862e-01, -6.932913e-02, 4.349633e-03, \
	4.843584e-02, 5.762197e-02, 4.069053e-02, 1.430997e-02, -5.929114e-03, \
	-0.0394207089
#define N_LP                  20
#define N_HP                  21

#define coeffLP_AGG  \
	-0.008747420411798365, -0.01352684070757768, -0.021069157456114974, \
	-0.02821205662046602, -0.03288466862750655, -0.032820056352546804, \
	-0.026015856418133178, -0.011326253746998683, 0.01118086152569252, \
	0.039926269347420495, 0.07195575020178693, 0.10331516426959793, \
	0.12972205191226951, 0.14735052987683003, 0.15353880775461448, \
	0.14735052987683003, 0.12972205191226951, 0.10331516426959793, \
	0.07195575020178693, 0.039926269347420495, 0.01118086152569252, \
	-0.011326253746998683, -0.026015856418133178, -0.032820056352546804, \
	-0.03288466862750655, -0.02821205662046602, -0.021069157456114974, \
	-0.01352684070757768, -0.008747420411798365
#define N_LP_AGG              29

#define coeffHP_AGG  \
	0.05946436587252379, -0.08266255914551396, -0.032374303236116855, \
	0.00216595808715192, 0.02865430955587078, 0.045067235048989344, \
	0.04435253660179216, 0.02016730464237364, -0.027703198625664668, \
	-0.0913071374380985, -0.15595705304807897, -0.2038996657538856, \
	0.7782265468798992, -0.2038996657538856, -0.15595705304807897, \
	-0.0913071374380985, -0.027703198625664668, 0.02016730464237364, \
	0.04435253660179216, 0.045067235048989344, 0.02865430955587078, \
	0.00216595808715192, -0.032374303236116855, -0.08266255914551396, \
	0.05946436587252379
#define N_HP_AGG              25

/* ---------------------------------------------------------------------------
 * Global variables
 * --------------------------------------------------------------------------- */
extern XIicPs Iic;
extern float LP[];
extern float HP[];
extern float LP_AGG[];
extern float HP_AGG[];

/* ---------------------------------------------------------------------------
 * Function declarations
 * --------------------------------------------------------------------------- */
int CodecRegWrite(XIicPs *IIcPtr, u8 regAddr, u16 regData);
int CodecInit(u16 timerID, u16 iicID, u32 i2sAddr);
void FifoTxWrite(u32 i2sBaseAddr, u32 audioData);
u32 FifoRxRead(u32 i2sBaseAddr);
void FifoInit(u32 fifoAddr);
int FirApply(int *buffer, float *coeff, int taps);

#endif /* AUDIO_FILTERING_H */
